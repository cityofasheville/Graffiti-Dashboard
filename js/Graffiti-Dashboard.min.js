/*! Graffiti-Dashboard 2014-08-13 */
"use strict";var graffitiAvl=angular.module("graffitiAvl",["ngRoute","ngTable"]).config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"html-templates/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]);angular.module("graffitiAvl").controller("MainCtrl",["$scope","$filter","ngTableParams","pubStuffFact","geoJsonFact",function(a,b,c,d,e){L.Icon.Default.imagePath="dependencies/js/images";var f,g=L.icon({iconUrl:"images/open.png",iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-28]}),h=L.icon({iconUrl:"images/completed.png",iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-28]}),i=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),j=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),k={Aerial:j,OSM:i},l=L.map("map",{center:[35.5951125,-82.5511088],zoom:13,layers:[j,i]});L.control.layers(k).addTo(l);{var m=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),n=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),o={Aerial:n,OSM:m},p=L.map("detailMap",{center:[35.5951125,-82.5511088],zoom:14,layers:[n,m]});L.control.layers(o).addTo(p)}a.map=!1,a.toggleDetailMap=function(){a.map=!a.map,a.map?(p.invalidateSize(),setTimeout(function(){p.invalidateSize()},500)):p.removeLayer(f)};var q=function(c){a.requestsList=b("orderBy")(c,"-DateCreatedInMillseconds",!1),a.totalRequests=totalParticpatingRequests.length,a.completed=completedParticpatingRequests.length,a.open=openParticpatingRequests.length,a.investmentByCity=0,a.costToPropertyOwners=0;for(var d=0;d<completedParticpatingRequests.length;d++)void 0!==completedParticpatingRequests[d].InvestmentByCity&&(a.investmentByCity+=Number(completedParticpatingRequests[d].InvestmentByCity)),void 0!==completedParticpatingRequests[d].CostToPropertyOwner&&(a.costToPropertyOwners+=Number(completedParticpatingRequests[d].CostToPropertyOwner));a.percentOfAllocatedFundsInvested=(a.investmentByCity/3e5*100).toFixed(0)+"%",s(totalParticpatingRequests),t(openParticpatingRequests),u(completedParticpatingRequests)},r=function(b){L.geoJson(e.generateGeoJsonFromRequestList(b),{style:function(a){var b={"in progress":"#d9534f",completed:"#5bc0de",submitted:"#5bc0de",accepted:"#5cb85c"};return{color:b[a.properties.Status]}},pointToLayer:function(a,b){return"completed"===a.properties.Status?new L.marker(b,{icon:h}):new L.marker(b,{icon:g})},onEachFeature:function(b,c){c.on("click",function(){a.getRequestDetails(b.properties),a.$apply()})}}).addTo(l)};a.getRequestDetails=function(b){p.setView([b.Latitude,b.Longitude],15),f=L.marker([b.Latitude,b.Longitude]).addTo(p),a.requestDetails={},a.requestDetails.requestDate=b.DateCreatedInMillseconds,a.requestDetails.imageThumbnail=b.ImageThumbnail,a.requestDetails.id=b.RequestID,a.requestDetails.status=b.Status,a.requestDetails.address=b.Address,a.requestDetails.description=b.Description,a.requestDetails.investmentByCity=void 0!==b.InvestmentByCity?b.InvestmentByCity:0,a.requestDetails.costToPropertyOwner=void 0!==b.CostToPropertyOwner?b.CostToPropertyOwner:0,$("#requestDetailsModal").modal()};var s=function(b){var d=b;a.totalRequestsTable=new c({page:1,count:10},{counts:[],total:d.length,getData:function(a,b){a.resolve(d.slice((b.page()-1)*b.count(),b.page()*b.count()))}})},t=function(b){var d=b;a.openRequestsTable=new c({page:1,count:10},{counts:[],total:d.length,getData:function(a,b){a.resolve(d.slice((b.page()-1)*b.count(),b.page()*b.count()))}})},u=function(b){var d=b;a.completedRequestsTable=new c({page:1,count:10},{counts:[],total:d.length,getData:function(a,b){a.resolve(d.slice((b.page()-1)*b.count(),b.page()*b.count()))}})};a.closeRequestDetail=function(){a.map=!1,p.removeLayer(f)},q(totalParticpatingRequests),r(totalParticpatingRequests)}]),graffitiAvl.factory("geoJsonFact",["$http","$q",function(){var a={};return a.generateGeoJsonFromRequestList=function(a){for(var b={type:"FeatureCollection",features:[]},c=0;c<a.length;c++){var d={type:"Feature",geometry:{type:"Point",coordinates:[a[c].Longitude,a[c].Latitude]},properties:a[c]};b.features.push(d)}return b},a}]),graffitiAvl.factory("pubStuffFact",["$http","$q",function(a,b){var c={},d=819,e="58j013k159vpqz87xd85df0uy7epvl";return c.getListOfRequestTypes=function(){var c=b.defer(),f={return_type:"json",client_id:d,api_key:e};return a({url:"https://www.publicstuff.com/api/2.0/requesttypes_list?",method:"GET",params:f}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),c.resolve(a.response.request_types)}).error(function(a){console.log(a)}),c.promise},c.getListOfRequests=function(c){var d=b.defer();return c.return_type="json",c.status="all",c.api_key="i952rk495itu254sx21141j2d3je3x",a({url:"https://www.publicstuff.com/api/2.0/requests_list?",method:"GET",params:c}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.getRequestDetails=function(c){var d=b.defer(),e={};return e.return_type="json",e.request_id=c,e.verbose=1,e.api_key="i952rk495itu254sx21141j2d3je3x",a({url:"https://www.publicstuff.com/api/2.0/request_view?",method:"GET",params:e}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.getCommentsForARequest=function(c){var d=b.defer();return c.return_type="json",a({url:"https://www.publicstuff.com/api/2.0/requests_list?",method:"GET",params:c}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.postAComment=function(c,d){var e=b.defer();return params.return_type="json",a({url:"https://www.publicstuff.com/api/2.0/requests_list?api_key=&request_id="+c+"&comment="+d,method:"POST",data:{}}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),e.resolve(a.response)}).error(function(a){console.log(a)}),e.promise},c}]);