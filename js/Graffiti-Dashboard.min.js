/*! Graffiti-Dashboard 2014-07-30 */
"use strict";var graffitiAvl=angular.module("graffitiAvl",["ngRoute"]).config(["$routeProvider","$locationProvider",function(a){a.when("/",{templateUrl:"html-templates/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]);angular.module("graffitiAvl").controller("MainCtrl",["$scope","$filter","pubStuffFact","geoJsonFact",function(b,c,d,e){L.Icon.Default.imagePath="dependencies/js/images",$("#loadingModal").modal();var f,g=L.icon({iconUrl:"images/open.png",iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-28]}),h=L.icon({iconUrl:"images/completed.png",iconSize:[32,37],iconAnchor:[16,37],popupAnchor:[0,-28]}),i=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),j=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),k={Aerial:j,OSM:i},l=L.map("map",{center:[35.5951125,-82.5511088],zoom:13,layers:[j,i]});L.control.layers(k).addTo(l);var m=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),n=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright" title="OpenStreetMap" target="_blank">OpenStreetMap</a> contributors | Tiles Courtesy of <a href="http://www.mapquest.com/" title="MapQuest" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" width="16" height="16">',subdomains:["otile1","otile2","otile3","otile4"]}),o={Aerial:n,OSM:m},p=L.map("detailMap",{center:[35.5951125,-82.5511088],zoom:14,layers:[m,n]}),q=L.control.layers(o).addTo(p);b.map=!1,b.toggleDetailMap=function(){b.map=!b.map,b.map?(p.invalidateSize(),setTimeout(function(){p.invalidateSize()},500)):p.removeLayer(f)};var r=function(a){b.requestsList=c("orderBy")(a,"-request.date_created",!1);var d=1e3*b.requestsList[0].request.date_created,e=new Date,f=e.getTime();b.daysSinceLastRequest=Math.floor(d/f/3600);for(var g=e.setDate(e.getDate()-30),h=e.setDate(e.getDate()-365),i=0,j=0,k=0;k<b.requestsList.length;k++)1e3*b.requestsList[k].request.date_created>g&&(i+=1),1e3*b.requestsList[k].request.date_created>h&&(j+=1);b.requestsLast30days=i,b.requestsLast365days=j,b.totalRequests=b.requestsList.length,b.completed=0,b.open=0,b.investmentByCity=0,b.costToPropertyOwners=0;for(var k=0;k<b.requestsList.length;k++){"completed"===b.requestsList[k].request.status?b.completed+=1:b.open+=1;for(var l=0;l<b.requestsList[k].request.custom_fields.length;l++)"Investment by City ($):"===b.requestsList[k].request.custom_fields[l].custom_field.name&&(b.investmentByCity+=Number(b.requestsList[k].request.custom_fields[l].custom_field.value)),"Cost to Property Owner ($):"===b.requestsList[k].request.custom_fields[l].custom_field.name&&(b.costToPropertyOwners+=Number(b.requestsList[k].request.custom_fields[l].custom_field.value))}b.percentOfAllocatedFundsInvested=(b.investmentByCity/3e5*100).toFixed(0)+"%"},s=function(a){var c=L.geoJson(e.generateGeoJsonFromRequestList(a),{style:function(a){var b={"in progress":"#d9534f",completed:"#5bc0de",submitted:"#5bc0de",accepted:"#5cb85c"};return{color:b[a.properties.status]}},pointToLayer:function(a,b){return"completed"===a.properties.status?new L.marker(b,{icon:h}):new L.marker(b,{icon:g})},onEachFeature:function(a,c){c.on("click",function(){b.getRequestDetails(a.properties),b.$apply()})}}).addTo(l);q.addOverlay(c)},t=[];d.getListOfRequestTypes().then(function(a){for(var b=0;b<a.length;b++)if("Graffiti"===a[b].request_type.name){var c=new Date(2014,5,1,0,0,0,0);d.getListOfRequests({verbose:1,request_type_id:a[b].request_type.id,limit:1e3,after_timestamp:c.getTime()/1e3}).then(function(a){$("#loadingModal").modal("toggle");for(var b=0;b<a.requests.length;b++)if(void 0!==a.requests[b].request.custom_fields)for(var c=0;c<a.requests[b].request.custom_fields.length;c++)"Graffiti Initiative Participant Property Type:"===a.requests[b].request.custom_fields[c].custom_field.name&&("2: City Property"===a.requests[b].request.custom_fields[c].custom_field.value||"3: Private Property"===a.requests[b].request.custom_fields[c].custom_field.value)&&t.push(a.requests[b]);r(t),s(t)})}}),b.getRequestDetails=function(a){p.setView([a.lat,a.lon],15),f=L.marker([a.lat,a.lon]).addTo(p),b.requestDetails={},b.requestDetails.requestDate=a.date_created,b.requestDetails.imageThumbnail=a.image_thumbnail,b.requestDetails.id=a.id,b.requestDetails.status=a.status,b.requestDetails.address=a.address,b.requestDetails.description=a.description,b.requestDetails.investmentByCity=0,b.requestDetails.costToPropertyOwner=0;for(var c=0;c<a.custom_fields.length;c++)"Investment by City ($):"===a.custom_fields[c].custom_field.name&&(b.requestDetails.investmentByCity=Number(a.custom_fields[c].custom_field.value)),"Cost to Property Owner ($):"===a.custom_fields[c].custom_field.name&&(b.requestDetails.costToPropertyOwner=Number(a.custom_fields[c].custom_field.value));$("#requestDetailsModal").modal()},b.closeRequestDetail=function(){b.map=!1,p.removeLayer(f)},b.posting=!1,b.postComment=function(e){b.comment="",b.posting=!1,d.postAComment(e,commment).then(function(){d.getCommentsForARequest(re).then(function(d){b.comments=c("orderBy")(d.comments,"-comment.create_date",!1),a.posting=!1})})}}]),graffitiAvl.factory("geoJsonFact",["$http","$q",function(){var a={};return a.generateGeoJsonFromRequestList=function(a){for(var b={type:"FeatureCollection",features:[]},c=0;c<a.length;c++){var d={type:"Feature",geometry:{type:"Point",coordinates:[a[c].request.lon,a[c].request.lat]},properties:a[c].request};b.features.push(d)}return b},a}]),graffitiAvl.factory("pubStuffFact",["$http","$q",function(a,b){var c={},d=819,e="58j013k159vpqz87xd85df0uy7epvl";return c.getListOfRequestTypes=function(){var c=b.defer(),f={return_type:"json",client_id:d,api_key:e};return a({url:"https://www.publicstuff.com/api/2.0/requesttypes_list?",method:"GET",params:f}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),c.resolve(a.response.request_types)}).error(function(a){console.log(a)}),c.promise},c.getListOfRequests=function(c){var d=b.defer();return c.return_type="json",c.status="all",c.api_key="i952rk495itu254sx21141j2d3je3x",a({url:"https://www.publicstuff.com/api/2.0/requests_list?",method:"GET",params:c}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.getRequestDetails=function(c){var d=b.defer(),e={};return e.return_type="json",e.request_id=c,e.verbose=1,e.api_key="i952rk495itu254sx21141j2d3je3x",a({url:"https://www.publicstuff.com/api/2.0/request_view?",method:"GET",params:e}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.getCommentsForARequest=function(c){var d=b.defer();return c.return_type="json",a({url:"https://www.publicstuff.com/api/2.0/requests_list?",method:"GET",params:c}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),d.resolve(a.response)}).error(function(a){console.log(a)}),d.promise},c.postAComment=function(c,d){var e=b.defer();return params.return_type="json",a({url:"https://www.publicstuff.com/api/2.0/requests_list?api_key=&request_id="+c+"&comment="+d,method:"POST",data:{}}).success(function(a){"error"===a.response.status.type&&console.log(a.response.status.message),e.resolve(a.response)}).error(function(a){console.log(a)}),e.promise},c}]);